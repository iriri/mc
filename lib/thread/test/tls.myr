use std
use sys
use thread

var start
var end
var wg

const setget = {
	for var i = start; i <= end; i++
		thread.tlsset(i, ((thread.tid() : thread.key) + i : void#))
	;;
	for var i = start; i <= end; i++
		std.assert(thread.tlsget(i) == ((thread.tid() : thread.key) + i : void#),
			"tls is broken\n")
	;;
	thread.wgpost(&wg)
}

const main = {
	start = thread.gettlskey()
	for var i = 0; i < 100; i++
		thread.gettlskey()
	;;
	end = thread.gettlskey()

	wg = thread.mkwg(101)
	for var i = 0; i < 100; i++
		thread.spawn(setget)
	;;
	setget()

	thread.wgwait(&wg)
}
